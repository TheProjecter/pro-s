<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.wozeze.pros.dao.target.TargetMapper">

	<insert id="insertTarget" parameterType="target">
		<selectKey keyProperty="id" resultType="string" order="BEFORE">
			SELECT sys_guid() FROM dual 
    	</selectKey>
		INSERT INTO
		TE_TARGET (ID, TARGET_NAME, BEGIN_DATE, END_DATE, DETAIL)
		VALUES
		(#{id}, #{name}, to_date(#{beginDate},'yyyy-mm-dd'), to_date(#{endDate},'yyyy-mm-dd'), #{detail})
	</insert>
	
	<insert id="insertTargetRelationTargetCatelog" parameterType="target">
		INSERT INTO
		TR_TARGET_CATELOG (TARGET_ID, CATELOG_ID)
		VALUES
		(#{id}, #{targetCatelog.id})
	</insert>
	
	<select id="queryTargets" parameterType="queryParam" resultType="target">
			SELECT t.id id,
				t.target_name name,
				t.detail detail,
				to_char(t.begin_date,'yyyy-mm-dd') beginDate,
				to_char(t.end_date,'yyyy-mm-dd') endDate,
				t2.catelog_name "targetCatelog.name"
			FROM te_target t
		JOIN tr_target_catelog t1 ON t.id = t1.target_id
		JOIN te_target_catelog t2 ON t1.catelog_id = t2.id
		<where>
			<if test="!all">
				<![CDATA[
				 t.ROWID IN
				  (
				      SELECT rid
				      FROM (
				           SELECT ROWNUM rn, rid
				             FROM (SELECT ROWID rid, ID FROM te_target)
				             WHERE ROWNUM <= #{page.startRow} + #{page.pageSize}     
				      )    
				      WHERE rn > #{page.startRow}
				  )
				]]>
			</if>
		</where>
	</select>
</mapper>